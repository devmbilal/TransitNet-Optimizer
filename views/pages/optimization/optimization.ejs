    <div class="optimization-container">
        <!-- Header Section -->
        <div class="optimization-header">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="page-title">
                            <i class="fas fa-route text-primary me-2"></i>
                            Route Optimization
                        </h1>
                        <p class="page-subtitle">
                            Optimize transit routes using advanced algorithms and mobility data analysis
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-outline-primary me-2" id="helpBtn">
                            <i class="fas fa-question-circle"></i> Help
                        </button>
                        <button class="btn btn-primary" id="newOptimizationBtn">
                            <i class="fas fa-plus"></i> New Optimization
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="optimization-content">
            <div class="container-fluid">
                <div class="row">
                    <!-- Left Sidebar -->
                    <div class="col-lg-3">
                        <div class="optimization-sidebar">
                            
                            <!-- Region Selection Card -->
                            <div class="card sidebar-card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-map-marker-alt me-2"></i>
                                        Region Selection
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <select class="form-select" id="regionSelect">
                                        <option value="">Select a region...</option>
                                        <% if (regions && regions.length > 0) { %>
                                            <% regions.forEach(region => { %>
                                                <option value="<%= region %>"><%= region %></option>
                                            <% }) %>
                                        <% } %>
                                    </select>
                                    
                                    <!-- Data Summary -->
                                    <div id="dataSummary" class="data-summary mt-3" style="display: none;">
                                        <div class="summary-item">
                                            <span class="summary-label">Mobility Areas:</span>
                                            <span class="summary-value" id="mobilityAreasCount">-</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">Matrix Files:</span>
                                            <span class="summary-value" id="matrixFilesCount">-</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">Transport Routes:</span>
                                            <span class="summary-value" id="transportRoutesCount">-</span>
                                        </div>
                                    <div class="readiness-indicator mt-2">
                                        <span id="readinessStatus" class="badge"></span>
                                    </div>
                                    
                                    <!-- Mobility Matrix File Selection -->
                                    <div id="mobilityMatrixSelection" class="mt-3" style="display: none;">
                                        <label class="form-label">Select Mobility Matrix File:</label>
                                        <select class="form-select form-select-sm" id="mobilityMatrixFileSelect">
                                            <option value="">Use all files</option>
                                        </select>
                                        <small class="form-text text-muted">Choose a specific mobility matrix file for optimization</small>
                                    </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Algorithm Parameters Card -->
                            <div class="card sidebar-card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-cogs me-2"></i>
                                        Algorithm Parameters
                                    </h6>
                                </div>
                                <div class="card-body algorithm-pane">
                                    <div class="mb-3">
                                        <label class="form-label">Distance Threshold (km)</label>
                                        <input type="number" class="form-control" id="distanceThreshold" 
                                               placeholder="Auto-calculate" step="0.1" min="1" max="100">
                                        <small class="form-text text-muted">Leave empty for auto-calculation</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Mobility Constant</label>
                                        <input type="number" class="form-control" id="mobilityConstant" 
                                               value="0.1" step="0.01" min="0.01" max="1">
                                        <small class="form-text text-muted">Weight transformation parameter</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Proximity Radius (m)</label>
                                        <input type="number" class="form-control" id="proximityRadius" 
                                               value="2000" step="100" min="500" max="10000">
                                        <small class="form-text text-muted">Maximum connection distance</small>
                                    </div>
                                    
                                    <hr class="my-3">
                                    <h6 class="mb-3">Recommendation Filters</h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Min Mobility Value</label>
                                        <input type="number" class="form-control" id="minMobility" 
                                               value="0.5" step="0.1" min="0.1" max="10">
                                        <small class="form-text text-muted">Minimum mobility for route recommendations</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Max Route Distance (km)</label>
                                        <input type="number" class="form-control" id="maxDistance" 
                                               value="40" step="5" min="5" max="100">
                                        <small class="form-text text-muted">Maximum recommended route distance</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Min Efficiency Ratio</label>
                                        <input type="number" class="form-control" id="minEfficiency" 
                                               value="0.01" step="0.01" min="0.001" max="1">
                                        <small class="form-text text-muted">Minimum mobility/distance ratio</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Cost Per Kilometer (PKR)</label>
                                        <input type="number" class="form-control" id="costPerKm" 
                                               value="50000" step="1000" min="10000" max="500000">
                                        <small class="form-text text-muted">Implementation cost per kilometer in Pakistani Rupees</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Sessions Card -->
                            <div class="card sidebar-card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-history me-2"></i>
                                        Recent Sessions
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="recentSessions" class="sessions-pane">
                                        <% if (recentSessions && recentSessions.length > 0) { %>
                                            <% recentSessions.forEach(session => { %>
                                                <div class="session-item" data-session-id="<%= session.sessionId %>">
                                                    <div class="session-info">
                                                        <div class="session-region"><%= session.region %></div>
                                                        <div class="session-date"><%= new Date(session.createdAt).toLocaleDateString() %></div>
                                                    </div>
                                                    <div class="session-status">
                                                        <span class="badge badge-<%= session.status %>"><%= session.status %></span>
                                                    </div>
                                                </div>
                                            <% }) %>
                                        <% } else { %>
                                            <div class="text-muted text-center py-3">
                                                <i class="fas fa-clock fa-2x mb-2"></i>
                                                <p class="mb-0">No recent sessions</p>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Area -->
                    <div class="col-lg-9">
                        
                        <!-- Welcome/Start Screen -->
                        <div id="welcomeScreen" class="welcome-screen">
                            <div class="card">
                                <div class="card-body text-center py-5">
                                    <i class="fas fa-route optimization-icon mb-4"></i>
                                    <h3 class="mb-3">Transit Route Optimization</h3>
                                    <p class="lead mb-4">
                                        Leverage advanced algorithms to optimize your transit network based on mobility patterns and distance analysis.
                                    </p>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <div class="feature-item">
                                                <i class="fas fa-chart-line feature-icon"></i>
                                                <h5>Data-Driven Analysis</h5>
                                                <p>Uses mobility matrices and distance data for informed decisions</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="feature-item">
                                                <i class="fas fa-network-wired feature-icon"></i>
                                                <h5>Network Optimization</h5>
                                                <p>Applies Dijkstra's algorithm for optimal path finding</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="feature-item">
                                                <i class="fas fa-lightbulb feature-icon"></i>
                                                <h5>Smart Recommendations</h5>
                                                <p>Generates prioritized route improvement suggestions</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="get-started-steps">
                                        <h5 class="mb-3">Get Started:</h5>
                                        <div class="steps-list">
                                            <div class="step-item">
                                                <span class="step-number">1</span>
                                                <span class="step-text">Select a region with mobility and transport data</span>
                                            </div>
                                            <div class="step-item">
                                                <span class="step-number">2</span>
                                                <span class="step-text">Configure optimization parameters (optional)</span>
                                            </div>
                                            <div class="step-item">
                                                <span class="step-number">3</span>
                                                <span class="step-text">Start the optimization process</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Optimization Progress Screen -->
                        <div id="progressScreen" class="progress-screen" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-cog fa-spin me-2"></i>
                                        Optimization in Progress
                                    </h5>
                                </div>
                                <div class="card-body">
                                    
                                    <!-- Overall Progress -->
                                    <div class="overall-progress mb-4">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="progress-label">Overall Progress</span>
                                            <span class="progress-percentage" id="overallProgress">0%</span>
                                        </div>
                                        <div class="progress progress-lg">
                                            <div class="progress-bar" id="overallProgressBar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>

                                    <!-- Phase Progress -->
                                    <div class="phases-container">
                                        <div class="phase-item" id="phase-dataPreparation">
                                            <div class="phase-header">
                                                <div class="phase-icon">
                                                    <i class="fas fa-database"></i>
                                                </div>
                                                <div class="phase-info">
                                                    <h6 class="phase-title">Data Preparation</h6>
                                                    <p class="phase-description">Loading mobility areas, matrix data, and cached distances</p>
                                                </div>
                                                <div class="phase-status">
                                                    <span class="status-badge">Pending</span>
                                                </div>
                                            </div>
                                            <div class="phase-progress">
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-item" id="phase-networkConstruction">
                                            <div class="phase-header">
                                                <div class="phase-icon">
                                                    <i class="fas fa-project-diagram"></i>
                                                </div>
                                                <div class="phase-info">
                                                    <h6 class="phase-title">Network Construction</h6>
                                                    <p class="phase-description">Building complete graph with dual edge weights</p>
                                                </div>
                                                <div class="phase-status">
                                                    <span class="status-badge">Pending</span>
                                                </div>
                                            </div>
                                            <div class="phase-progress">
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-item" id="phase-distanceFiltering">
                                            <div class="phase-header">
                                                <div class="phase-icon">
                                                    <i class="fas fa-filter"></i>
                                                </div>
                                                <div class="phase-info">
                                                    <h6 class="phase-title">Distance Filtering</h6>
                                                    <p class="phase-description">Applying threshold to create sparse connected graph</p>
                                                </div>
                                                <div class="phase-status">
                                                    <span class="status-badge">Pending</span>
                                                </div>
                                            </div>
                                            <div class="phase-progress">
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-item" id="phase-mobilityOptimization">
                                            <div class="phase-header">
                                                <div class="phase-icon">
                                                    <i class="fas fa-route"></i>
                                                </div>
                                                <div class="phase-info">
                                                    <h6 class="phase-title">Mobility Optimization</h6>
                                                    <p class="phase-description">Finding optimal paths using Dijkstra's algorithm</p>
                                                </div>
                                                <div class="phase-status">
                                                    <span class="status-badge">Pending</span>
                                                </div>
                                            </div>
                                            <div class="phase-progress">
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-item" id="phase-resultsGeneration">
                                            <div class="phase-header">
                                                <div class="phase-icon">
                                                    <i class="fas fa-chart-bar"></i>
                                                </div>
                                                <div class="phase-info">
                                                    <h6 class="phase-title">Results Generation</h6>
                                                    <p class="phase-description">Analyzing results and generating recommendations</p>
                                                </div>
                                                <div class="phase-status">
                                                    <span class="status-badge">Pending</span>
                                                </div>
                                            </div>
                                            <div class="phase-progress">
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Progress Actions -->
                                    <div class="progress-actions mt-4 text-center">
                                        <button class="btn btn-outline-secondary me-2" id="cancelOptimization">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                        <button class="btn btn-primary" id="viewProgressDetails">
                                            <i class="fas fa-info-circle"></i> View Details
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Results Screen -->
                        <div id="resultsScreen" class="results-screen" style="display: none;">
                            <div class="row">
                                
                                <!-- Results Summary Card -->
                                <div class="col-12 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="fas fa-chart-line me-2 text-success"></i>
                                                Optimization Results Summary
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <div class="metric-card">
                                                        <div class="metric-value" id="mobilityImprovement">-</div>
                                                        <div class="metric-label">Mobility Increase</div>
                                                        <div class="metric-unit">%</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="metric-card">
                                                        <div class="metric-value" id="distanceReduction">-</div>
                                                        <div class="metric-label">Distance Reduction</div>
                                                        <div class="metric-unit">%</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="metric-card">
                                                        <div class="metric-value" id="efficiencyGain">-</div>
                                                        <div class="metric-label">Efficiency Gain</div>
                                                        <div class="metric-unit">%</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="metric-card">
                                                        <div class="metric-value" id="recommendationsCount">-</div>
                                                        <div class="metric-label">Route Recommendations</div>
                                                        <div class="metric-unit">routes</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recommendations and Visualization -->
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-list-ol me-2"></i>
                                                Route Recommendations
                                            </h6>
                                        </div>
                                        <div class="card-body recommendations-body">
                                            <div id="recommendationsList">
                                                <!-- Recommendations will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-map me-2"></i>
                                                Route Visualization
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="resultsMap" style="height: 400px;"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Detailed Analysis -->
                                <div class="col-12 mt-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <div class="row align-items-center">
                                                <div class="col">
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-analytics me-2"></i>
                                                        Detailed Analysis
                                                    </h6>
                                                </div>
                                                <div class="col-auto">
                                                    <button class="btn btn-success btn-sm me-2" id="exportRecommendations">
                                                        <i class="fas fa-download"></i> Export Recommendations
                                                    </button>
                                                    <button class="btn btn-primary btn-sm" id="exportRoutes">
                                                        <i class="fas fa-download"></i> Export Routes
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <canvas id="networkComparisonChart" width="400" height="200"></canvas>
                                                </div>
                                                <div class="col-md-6">
                                                    <canvas id="improvementChart" width="400" height="200"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

<% if (typeof error !== 'undefined' && error) { %>
    <script>
        console.error('Server Error:', '<%= error %>');
        alert('Error loading optimization page: <%= error %>');
    </script>
<% } %>
