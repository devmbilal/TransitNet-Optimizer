<!-- Main Content Layout -->
<div class="row">
  <!-- Left Sidebar: Region & Routes List -->
  <div class="col-md-3">
    <div style="height: 650px; overflow-y: auto;">
      <div class="p-3">
        
        <!-- Region Selection Card -->
        <div class="card mb-3 border-0 shadow-sm">
          <div class="card-header bg-primary text-white py-2">
            <h6 class="mb-0"><i class="bi bi-geo-alt-fill"></i> Select Region</h6>
          </div>
          <div class="card-body p-3">
            <div class="mb-2">
              <select class="form-select form-select-sm" id="regionSelect" onchange="loadRoutesForRegion(this.value)">
                <option value="" selected disabled>Choose a region...</option>
                <% regions.forEach(region => { %>
                <option value="<%= region %>"><%= region %></option>
                <% }) %>
              </select>
            </div>
            <div class="small text-muted">
              <i class="bi bi-info-circle"></i> Current: <span id="currentRegionDisplay">None selected</span>
            </div>
          </div>
        </div>

        <!-- Routes List Card -->
        <div class="card mb-3 border-0 shadow-sm">
          <div class="card-header bg-success text-white py-2 d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-list-ul"></i> Existing Routes</h6>
            <button class="btn btn-outline-light btn-sm" onclick="createNewRoute()" title="Create New Route">
              <i class="bi bi-plus-circle"></i> New
            </button>
          </div>
          <div class="card-body p-3" style="min-height: 300px; max-height: 300px; overflow-y: auto;">
            <div id="routesListContainer">
              <div class="text-muted text-center py-3">
                <i class="bi bi-info-circle"></i> Select a region to view routes
              </div>
            </div>
          </div>
        </div>

        <!-- Route Actions Card -->
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-warning text-dark py-2">
            <h6 class="mb-0"><i class="bi bi-tools"></i> Route Actions</h6>
          </div>
          <div class="card-body p-3">
            <div class="d-grid gap-2">
              <button id="saveRouteBtn" class="btn btn-success btn-sm" onclick="saveCurrentRoute()" disabled>
                <i class="bi bi-save"></i> Save Route
              </button>
              <button id="cancelRouteBtn" class="btn btn-secondary btn-sm" onclick="cancelRouteEditing()" disabled>
                <i class="bi bi-x-circle"></i> Cancel
              </button>
              <button id="exportRouteBtn" class="btn btn-info btn-sm" onclick="exportCurrentRoute()" disabled>
                <i class="bi bi-download"></i> Export CSV
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Center: Interactive Map -->
  <div class="col-md-6">
    <div class="p-3">
      <div class="card border-0 shadow">
        <div class="card-header bg-info text-white py-2 d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="bi bi-map"></i> Interactive Route Map</h6>
          <div>
            <span id="currentRouteTitle" class="badge bg-light text-dark">No route selected</span>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="position-relative" style="height: 600px;">
            <div id="routeMap" class="h-100 w-100" style="height: 600px; min-height: 600px;"></div>
            <!-- Map Loading Overlay -->
            <div id="mapOverlay" class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75" style="z-index: 1000; display: none !important;">
              <div class="text-center">
                <div class="spinner-border text-info" role="status"></div>
                <div class="mt-2">Loading map...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Sidebar: Stops Management -->
  <div class="col-md-3">
    <div style="height: 650px; overflow-y: auto;">
      <div class="p-3">
        
        <!-- Current Route Info -->
        <div class="card mb-3 border-0 shadow-sm">
          <div class="card-header bg-secondary text-white py-2">
            <h6 class="mb-0"><i class="bi bi-info-circle"></i> Route Information</h6>
          </div>
          <div class="card-body p-3">
            <div class="mb-2">
              <label class="form-label small fw-bold">Route Name:</label>
              <input type="text" id="routeNameInput" class="form-control form-control-sm" placeholder="Enter route name..." disabled>
            </div>
            <div class="row g-2 small">
              <div class="col-6">
                <div class="text-muted">Total Stops:</div>
                <div id="totalStopsCount" class="fw-bold text-primary">0</div>
              </div>
              <div class="col-6">
                <div class="text-muted">Route Length:</div>
                <div id="routeLength" class="fw-bold text-success">0 km</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Stops List Card -->
        <div class="card mb-3 border-0 shadow-sm">
          <div class="card-header bg-warning text-dark py-2 d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-geo-alt"></i> Route Stops</h6>
            <button class="btn btn-outline-dark btn-sm" onclick="clearAllStops()" title="Clear All Stops" disabled id="clearStopsBtn">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <div class="card-body p-2" style="min-height: 350px; max-height: 350px; overflow-y: auto;">
            <div class="mb-2 text-muted small">
              <i class="bi bi-info-circle"></i> Click on map to add stops or drag to reorder
            </div>
            <div id="stopsListContainer">
              <div id="emptyStopsMessage" class="text-center text-muted py-4">
                <i class="bi bi-pin-map fs-1"></i>
                <div class="mt-2">No stops added yet</div>
                <div class="small">Click on the map to add your first stop</div>
              </div>
              <ul id="sortableStopsList" class="list-unstyled" style="display: none;">
                <!-- Dynamic stops will be added here -->
              </ul>
            </div>
          </div>
        </div>

        <!-- Add Stop Manually Card -->
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-dark text-white py-2">
            <h6 class="mb-0"><i class="bi bi-plus-square"></i> Add Stop Manually</h6>
          </div>
          <div class="card-body p-3">
            <div class="mb-2">
              <input type="text" id="manualStopName" class="form-control form-control-sm" placeholder="Stop name..." disabled>
            </div>
            <div class="row g-2 mb-2">
              <div class="col-6">
                <input type="number" id="manualStopLat" class="form-control form-control-sm" placeholder="Latitude" step="any" disabled>
              </div>
              <div class="col-6">
                <input type="number" id="manualStopLng" class="form-control form-control-sm" placeholder="Longitude" step="any" disabled>
              </div>
            </div>
            <div class="d-grid">
              <button id="addManualStopBtn" class="btn btn-dark btn-sm" onclick="addManualStop()" disabled>
                <i class="bi bi-plus-circle"></i> Add Stop
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Stop Details Modal -->
<div class="modal fade" id="stopDetailsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-geo-alt-fill"></i> Stop Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">Stop Name</label>
          <input type="text" id="modalStopName" class="form-control" placeholder="Enter stop name...">
        </div>
        <div class="row g-3">
          <div class="col-6">
            <label class="form-label fw-bold">Latitude</label>
            <input type="number" id="modalStopLat" class="form-control" step="any" readonly>
          </div>
          <div class="col-6">
            <label class="form-label fw-bold">Longitude</label>
            <input type="number" id="modalStopLng" class="form-control" step="any" readonly>
          </div>
        </div>
        <div class="mt-3 text-muted small">
          <i class="bi bi-info-circle"></i> You can drag the marker on the map to change the location
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveStopDetails()">
          <i class="bi bi-save"></i> Save Stop
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationTitle">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="confirmationMessage">Are you sure you want to perform this action?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Route Name Modal -->
<div class="modal fade" id="routeNameModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle-fill"></i> <span id="routeNameModalTitle">Create New Route</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">Route Name</label>
          <input type="text" id="modalRouteName" class="form-control" placeholder="Enter route name...">
          <div class="form-text">Choose a unique name for this route</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="confirmCreateRoute()">
          <i class="bi bi-plus-circle"></i> Create Route
        </button>
      </div>
    </div>
  </div>
</div>
